{% extends "base.html" %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-2">
                <li class="breadcrumb-item"><a href="{% url 'jobs:list' %}">Jobs</a></li>
                <li class="breadcrumb-item active">{{ job.id|truncatechars:12 }}</li>
            </ol>
        </nav>
        <h1><i class="bi bi-terminal me-2"></i>Job Details</h1>
    </div>
    <div>
        {% if job.status == 'succeeded' %}
        <span class="badge bg-success fs-5"><i class="bi bi-check-circle me-1"></i>Succeeded</span>
        {% elif job.status == 'failed' %}
        <span class="badge bg-danger fs-5"><i class="bi bi-x-circle me-1"></i>Failed</span>
        {% elif job.status == 'running' %}
        <span class="badge bg-primary fs-5"><i class="bi bi-hourglass-split me-1"></i>Running</span>
        {% elif job.status == 'lost' %}
        <span class="badge bg-warning text-dark fs-5"><i class="bi bi-exclamation-triangle me-1"></i>Lost</span>
        {% else %}
        <span class="badge bg-secondary fs-5"><i class="bi bi-clock me-1"></i>Queued</span>
        {% endif %}
    </div>
</div>

<!-- Job Info -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-info-circle me-1"></i>Job Information
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    <tr>
                        <td class="text-muted" style="width: 120px;">Job ID</td>
                        <td><code>{{ job.id }}</code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Target Node</td>
                        <td>
                            <a href="{% url 'jobs:node_detail' job.target_node.name %}">
                                {{ job.target_node.name }}
                            </a>
                            <span class="text-muted">({{ job.target_node.host }})</span>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Description</td>
                        <td id="job-description-section">
                            {% include "jobs/partials/job_description.html" %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Exit Code</td>
                        <td>
                            {% if job.exit_code is not None %}
                            <code class="{% if job.exit_code == 0 %}text-success{% else %}text-danger{% endif %}">{{ job.exit_code }}</code>
                            {% else %}
                            <span class="text-muted">Not available</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Duration</td>
                        <td>
                            {% if job.duration_ms %}
                            {{ job.duration_ms }}ms
                            {% else %}
                            <span class="text-muted">Not available</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">Created</td>
                        <td>{{ job.created_at }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">Updated</td>
                        <td>{{ job.updated_at }}</td>
                    </tr>
                </table>
            </div>
            {% if job.status == 'running' %}
            <div class="card-footer">
                <button 
                    class="btn btn-success"
                    hx-get="{% url 'jobs:check_status' job.id %}"
                    hx-target="#job-check-result"
                    hx-indicator="#job-check-spinner"
                >
                    <span id="job-check-spinner" class="htmx-indicator spinner-border spinner-border-sm me-1"></span>
                    <i class="bi bi-wifi me-1"></i>Check Job Status
                </button>
            </div>
            {% endif %}
        </div>
        {% if job.status == 'running' %}
        <!-- Job Status Check Result -->
        <div id="job-check-result" class="mt-3"></div>
        {% endif %}
    </div>
    <div class="col-md-6">
        <div class="card h-100">
            <div class="card-header">
                <i class="bi bi-code me-1"></i>Command
            </div>
            <div class="card-body">
                <pre class="mb-0 p-3 bg-dark rounded" style="max-height: 200px; overflow-y: auto;"><code>{{ job.command }}</code></pre>
            </div>
        </div>
    </div>
</div>

<!-- Output -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="outputTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="stdout-tab" data-bs-toggle="tab" data-bs-target="#stdout" type="button">
                            <i class="bi bi-terminal me-1"></i>stdout
                            {% if job.stdout %}<span class="badge bg-primary ms-1">{{ job.stdout|length }}</span>{% endif %}
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if job.stderr %}text-danger{% endif %}" id="stderr-tab" data-bs-toggle="tab" data-bs-target="#stderr" type="button">
                            <i class="bi bi-exclamation-triangle me-1"></i>stderr
                            {% if job.stderr %}<span class="badge bg-danger ms-1">{{ job.stderr|length }}</span>{% endif %}
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body p-0">
                <div class="tab-content" id="outputTabContent">
                    <div class="tab-pane fade show active" id="stdout" role="tabpanel">
                        {% if job.stdout %}
                        <pre class="mb-0 p-3" style="max-height: 500px; overflow-y: auto; background: #0d1117;"><code>{{ job.stdout }}</code></pre>
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-inbox display-6 d-block mb-2"></i>
                            No standard output
                        </div>
                        {% endif %}
                    </div>
                    <div class="tab-pane fade" id="stderr" role="tabpanel">
                        {% if job.stderr %}
                        <pre class="mb-0 p-3 text-danger" style="max-height: 500px; overflow-y: auto; background: #0d1117;"><code>{{ job.stderr }}</code></pre>
                        {% else %}
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-check-circle display-6 d-block mb-2"></i>
                            No error output
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actions -->
<div class="mt-4">
    <a href="{% url 'jobs:list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-1"></i>Back to Jobs
    </a>
    {% if job.status == 'running' %}
    <button 
        class="btn btn-success ms-2"
        hx-get="{% url 'jobs:check_status' job.id %}"
        hx-target="#job-check-result"
        hx-indicator="#job-check-spinner-bottom"
    >
        <span id="job-check-spinner-bottom" class="htmx-indicator spinner-border spinner-border-sm me-1"></span>
        <i class="bi bi-wifi me-1"></i>Check Job Status
    </button>
    {% endif %}
    <a href="{% url 'jobs:submit' %}?node={{ job.target_node.name }}&command={{ job.command|urlencode }}" class="btn btn-outline-primary ms-2">
        <i class="bi bi-arrow-repeat me-1"></i>Run Again
    </a>
</div>
{% if job.status == 'running' %}
<!-- Job Status Check Result (bottom) -->
<div id="job-check-result" class="mt-3"></div>
{% endif %}
{% endblock %}

