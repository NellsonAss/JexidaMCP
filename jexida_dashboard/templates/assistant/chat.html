{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-robot me-2"></i>AI Assistant</h1>
    <p class="text-muted">Chat with your AI assistant</p>
</div>

<div class="row">
    <div class="col-12">
        <div class="card" style="min-height: 600px;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-chat-dots me-2"></i>Chat</span>
                <span id="status-indicator" class="badge bg-success">Ready</span>
            </div>
            <div class="card-body d-flex flex-column">
                <!-- Messages Container -->
                <div id="messages" class="flex-grow-1 overflow-auto mb-3" style="max-height: 400px;">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-square-text display-4 d-block mb-3"></i>
                        Start a conversation with your AI assistant
                    </div>
                </div>
                
                <!-- Input Form -->
                <form id="chat-form" class="mt-auto">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" 
                               placeholder="Type your message..." autofocus>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const messagesContainer = document.getElementById('messages');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const statusIndicator = document.getElementById('status-indicator');

let conversationId = null;

function addMessage(role, content) {
    // Clear placeholder if first message
    if (messagesContainer.querySelector('.text-center')) {
        messagesContainer.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 ${role === 'user' ? 'text-end' : ''}`;
    
    const badge = role === 'user' ? 'bg-primary' : 'bg-secondary';
    const icon = role === 'user' ? 'person' : 'robot';
    
    messageDiv.innerHTML = `
        <div class="d-inline-block p-3 rounded ${role === 'user' ? 'bg-primary text-white' : 'bg-dark'}" style="max-width: 80%;">
            <small class="d-block mb-1 text-muted">
                <i class="bi bi-${icon} me-1"></i>${role === 'user' ? 'You' : 'Assistant'}
            </small>
            <div>${content.replace(/\n/g, '<br>')}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage('user', message);
    messageInput.value = '';
    
    // Update status
    statusIndicator.textContent = 'Thinking...';
    statusIndicator.className = 'badge bg-warning';
    
    try {
        const response = await fetch('/api/assistant/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                message: message,
                conversation_id: conversationId,
            }),
        });
        
        const data = await response.json();
        
        if (data.error) {
            addMessage('assistant', `Error: ${data.error}`);
        } else {
            conversationId = data.conversation_id;
            addMessage('assistant', data.content);
        }
        
        // Update status
        statusIndicator.textContent = 'Ready';
        statusIndicator.className = 'badge bg-success';
        
    } catch (error) {
        addMessage('assistant', `Error: ${error.message}`);
        statusIndicator.textContent = 'Error';
        statusIndicator.className = 'badge bg-danger';
    }
});
</script>
{% endblock %}

