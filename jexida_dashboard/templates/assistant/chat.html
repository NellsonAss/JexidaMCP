{% extends "base.html" %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <div>
        <h1><i class="bi bi-robot me-2"></i>AI Assistant</h1>
        <p class="text-muted">Chat with your MCP-powered AI assistant</p>
    </div>
    <div>
        <button class="btn btn-outline-secondary btn-sm" onclick="showToolsInfo()">
            <i class="bi bi-tools me-1"></i>View Available Tools
        </button>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card" style="min-height: 600px;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-chat-dots me-2"></i>Chat</span>
                <div>
                    <span id="tools-count" class="badge bg-info me-2" title="MCP Tools Available">
                        <i class="bi bi-tools me-1"></i>Loading...
                    </span>
                    <span id="status-indicator" class="badge bg-success">Ready</span>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <!-- Messages Container -->
                <div id="messages" class="flex-grow-1 overflow-auto mb-3" style="max-height: 450px;">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-square-text display-4 d-block mb-3"></i>
                        <p>Start a conversation with your AI assistant</p>
                        <small class="text-muted">The assistant can execute MCP tools to help manage your infrastructure</small>
                    </div>
                </div>
                
                <!-- Input Form -->
                <form id="chat-form" class="mt-auto">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" id="message-input" class="form-control" 
                               placeholder="Ask me to check your network, run audits, manage devices..." autofocus>
                        <button type="submit" class="btn btn-primary" id="send-btn">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                    <small class="text-muted mt-1 d-block">
                        Try: "List my UniFi devices" or "Run a security audit on my network"
                    </small>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Tool Confirmation Modal -->
<div class="modal fade" id="toolConfirmModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-shield-exclamation me-2"></i>Confirm Tool Execution
                </h5>
            </div>
            <div class="modal-body">
                <div id="confirm-risk-badge" class="mb-3"></div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="confirm-reason">This tool requires confirmation before execution.</span>
                </div>
                
                <h6><i class="bi bi-gear me-2"></i>Tool Details</h6>
                <table class="table table-sm">
                    <tr>
                        <td class="text-muted" style="width: 120px;">Tool Name</td>
                        <td><code id="confirm-tool-name"></code></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Description</td>
                        <td id="confirm-tool-description"></td>
                    </tr>
                </table>
                
                <h6 class="mt-3"><i class="bi bi-code-square me-2"></i>Parameters</h6>
                <pre id="confirm-parameters" class="bg-dark text-light p-3 rounded" style="max-height: 200px; overflow: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancel-tool-btn">
                    <i class="bi bi-x-circle me-1"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirm-tool-btn">
                    <i class="bi bi-check-circle me-1"></i>Execute Tool
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tools Info Modal -->
<div class="modal fade" id="toolsInfoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-tools me-2"></i>Available MCP Tools
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="tools-info-content">Loading...</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const messagesContainer = document.getElementById('messages');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const statusIndicator = document.getElementById('status-indicator');
const toolsCount = document.getElementById('tools-count');
const sendBtn = document.getElementById('send-btn');

let conversationId = null;
let pendingToolCall = null;

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadStatus();
    setupConfirmModal();
});

async function loadStatus() {
    try {
        const response = await fetch('/api/assistant/status/');
        const data = await response.json();
        
        if (data.mcp_tools) {
            toolsCount.innerHTML = `<i class="bi bi-tools me-1"></i>${data.mcp_tools.total} Tools`;
            toolsCount.title = `${data.mcp_tools.total} MCP tools available`;
        }
    } catch (error) {
        toolsCount.innerHTML = '<i class="bi bi-tools me-1"></i>?';
    }
}

function addMessage(role, content, extras = {}) {
    // Clear placeholder if first message
    if (messagesContainer.querySelector('.text-center')) {
        messagesContainer.innerHTML = '';
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `mb-3 ${role === 'user' ? 'text-end' : ''}`;
    
    const icon = role === 'user' ? 'person' : 'robot';
    const bgClass = role === 'user' ? 'bg-primary text-white' : 'bg-dark';
    
    let extraContent = '';
    
    // Show tool execution results
    if (extras.tool_results && extras.tool_results.length > 0) {
        extraContent += '<div class="mt-2 pt-2 border-top border-secondary">';
        extraContent += '<small class="text-muted d-block mb-1"><i class="bi bi-gear me-1"></i>Tool Executions:</small>';
        
        for (const result of extras.tool_results) {
            const statusIcon = result.success ? 'check-circle text-success' : 'x-circle text-danger';
            const statusText = result.success ? 'Success' : 'Failed';
            
            extraContent += `
                <div class="small mb-1">
                    <i class="bi bi-${statusIcon} me-1"></i>
                    <code>${result.tool_name}</code>: ${statusText}
                </div>
            `;
            
            if (result.error) {
                extraContent += `<div class="text-danger small">${result.error}</div>`;
            }
        }
        extraContent += '</div>';
    }
    
    // Format content - handle markdown-ish formatting
    let formattedContent = content
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/```json\n([\s\S]*?)```/g, '<pre class="bg-dark border border-secondary p-2 rounded mt-2" style="font-size: 0.8em;">$1</pre>')
        .replace(/```([\s\S]*?)```/g, '<pre class="bg-dark border border-secondary p-2 rounded mt-2" style="font-size: 0.8em;">$1</pre>')
        .replace(/\n/g, '<br>');
    
    messageDiv.innerHTML = `
        <div class="d-inline-block p-3 rounded ${bgClass}" style="max-width: 85%; text-align: left;">
            <small class="d-block mb-1 ${role === 'user' ? 'text-white-50' : 'text-muted'}">
                <i class="bi bi-${icon} me-1"></i>${role === 'user' ? 'You' : 'Assistant'}
            </small>
            <div>${formattedContent}</div>
            ${extraContent}
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function addToolPendingMessage(toolCall) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'mb-3';
    messageDiv.id = `pending-${toolCall.id}`;
    
    const riskClass = toolCall.risk_level === 'dangerous' ? 'danger' : 
                      toolCall.risk_level === 'moderate' ? 'warning' : 'info';
    
    messageDiv.innerHTML = `
        <div class="d-inline-block p-3 rounded bg-dark" style="max-width: 85%;">
            <small class="d-block mb-1 text-muted">
                <i class="bi bi-robot me-1"></i>Assistant
            </small>
            <div class="mb-2">I need to execute a tool that requires your confirmation:</div>
            <div class="alert alert-${riskClass} mb-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-gear me-2"></i>
                        <strong>${toolCall.tool_name}</strong>
                    </div>
                    <span class="badge bg-${riskClass}">${toolCall.risk_level}</span>
                </div>
                <small class="d-block mt-1">${toolCall.reason}</small>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-light" onclick="showConfirmModal()">
                    <i class="bi bi-eye me-1"></i>Review & Confirm
                </button>
                <button class="btn btn-sm btn-outline-danger" onclick="cancelPendingTool()">
                    <i class="bi bi-x me-1"></i>Cancel
                </button>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function setStatus(status, type = 'success') {
    statusIndicator.textContent = status;
    statusIndicator.className = `badge bg-${type}`;
}

function setInputEnabled(enabled) {
    messageInput.disabled = !enabled;
    sendBtn.disabled = !enabled;
}

chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage('user', message);
    messageInput.value = '';
    
    // Update status
    setStatus('Thinking...', 'warning');
    setInputEnabled(false);
    
    try {
        const response = await fetch('/api/assistant/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                message: message,
                conversation_id: conversationId,
            }),
        });
        
        const data = await response.json();
        
        if (data.error) {
            addMessage('assistant', `Error: ${data.error}`);
            setStatus('Error', 'danger');
        } else {
            conversationId = data.conversation_id;
            
            // Check for pending tool call
            if (data.pending_tool_call) {
                pendingToolCall = data.pending_tool_call;
                
                // Show message about pending tool
                if (data.content) {
                    addMessage('assistant', data.content);
                }
                addToolPendingMessage(data.pending_tool_call);
                
                setStatus('Awaiting Confirmation', 'warning');
            } else {
                // Normal response
                addMessage('assistant', data.content, {
                    tool_results: data.tool_results,
                });
                setStatus('Ready', 'success');
            }
        }
        
    } catch (error) {
        addMessage('assistant', `Error: ${error.message}`);
        setStatus('Error', 'danger');
    }
    
    setInputEnabled(true);
    messageInput.focus();
});

function setupConfirmModal() {
    const modal = document.getElementById('toolConfirmModal');
    const confirmBtn = document.getElementById('confirm-tool-btn');
    const cancelBtn = document.getElementById('cancel-tool-btn');
    
    confirmBtn.addEventListener('click', () => confirmTool(true));
    cancelBtn.addEventListener('click', () => confirmTool(false));
}

function showConfirmModal() {
    if (!pendingToolCall) return;
    
    const tc = pendingToolCall;
    
    // Set risk badge
    const riskBadge = document.getElementById('confirm-risk-badge');
    const riskClass = tc.risk_level === 'dangerous' ? 'danger' : 
                      tc.risk_level === 'moderate' ? 'warning' : 'info';
    riskBadge.innerHTML = `<span class="badge bg-${riskClass} fs-6">${tc.risk_level.toUpperCase()} RISK</span>`;
    
    // Set details
    document.getElementById('confirm-reason').textContent = tc.reason;
    document.getElementById('confirm-tool-name').textContent = tc.tool_name;
    document.getElementById('confirm-tool-description').textContent = tc.tool_description || 'No description available';
    document.getElementById('confirm-parameters').textContent = JSON.stringify(tc.parameters, null, 2);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('toolConfirmModal'));
    modal.show();
}

async function confirmTool(confirmed) {
    if (!pendingToolCall) return;
    
    // Hide modal
    const modalEl = document.getElementById('toolConfirmModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
    
    // Remove pending message
    const pendingMsg = document.getElementById(`pending-${pendingToolCall.id}`);
    if (pendingMsg) pendingMsg.remove();
    
    setStatus(confirmed ? 'Executing...' : 'Cancelling...', 'warning');
    setInputEnabled(false);
    
    try {
        const response = await fetch('/api/assistant/confirm-tool/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                tool_call_id: pendingToolCall.id,
                confirmed: confirmed,
            }),
        });
        
        const data = await response.json();
        
        if (data.error) {
            addMessage('assistant', `Error: ${data.error}`);
            setStatus('Error', 'danger');
        } else if (data.cancelled) {
            addMessage('assistant', `Tool execution cancelled: **${data.tool_name}**`);
            setStatus('Ready', 'success');
        } else {
            // Tool was executed
            addMessage('assistant', data.content, {
                tool_results: [{
                    tool_name: data.tool_name,
                    success: data.success,
                    error: data.error,
                }],
            });
            setStatus('Ready', 'success');
        }
        
    } catch (error) {
        addMessage('assistant', `Error confirming tool: ${error.message}`);
        setStatus('Error', 'danger');
    }
    
    pendingToolCall = null;
    setInputEnabled(true);
    messageInput.focus();
}

function cancelPendingTool() {
    confirmTool(false);
}

async function showToolsInfo() {
    const content = document.getElementById('tools-info-content');
    const modal = new bootstrap.Modal(document.getElementById('toolsInfoModal'));
    
    content.innerHTML = '<div class="text-center py-3"><div class="spinner-border"></div></div>';
    modal.show();
    
    try {
        const response = await fetch('/api/assistant/status/');
        const data = await response.json();
        
        if (data.mcp_tools && data.mcp_tools.categories) {
            let html = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>${data.mcp_tools.total}</strong> MCP tools available for the AI assistant to use.
                </div>
                <h6>Tool Categories</h6>
                <div class="row">
            `;
            
            for (const [category, count] of Object.entries(data.mcp_tools.categories)) {
                html += `
                    <div class="col-md-4 mb-2">
                        <div class="d-flex justify-content-between align-items-center p-2 bg-dark rounded">
                            <span>${category}</span>
                            <span class="badge bg-primary">${count}</span>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            html += `
                <div class="mt-3">
                    <a href="/tools/" class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-arrow-right me-1"></i>View All Tools
                    </a>
                </div>
            `;
            
            content.innerHTML = html;
        } else {
            content.innerHTML = '<div class="alert alert-warning">No tools information available.</div>';
        }
    } catch (error) {
        content.innerHTML = `<div class="alert alert-danger">Error loading tools: ${error.message}</div>`;
    }
}
</script>
{% endblock %}
